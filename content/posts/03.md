---
title: "Rancherの立ち上げ"
date: 2020-12-22T12:11:23+09:00
draft: true
weight: 4
---

## Rancher
***
#### 立ち上げ方法
※[参考リンク](https://rancher.com/docs/rancher/v2.x/en/quick-start-guide/deployment/quickstart-manual-setup/)

* コンテナの起動
ポートは被ると面倒なのでずらす。
Versionは2.4.8でないと上手くいかなかったので注意
```
$ sudo docker run -d --restart=unless-stopped -p 8080:80 -p 8443:443 rancher/rancher:v2.4.8
```

課題１：Docker-compose使ってやってみる
{{%expand "課題１回答" %}} 

```
$ mkdir rancher_test
$ cd rancher_test
$ vim docker-compose.yml
```
__docker-compose.yml__
```
version: '3'
services:
  rancher:
    restart: always
    image: rancher/rancher:v2.4.8
    ports:
      - "8080:80"
      - "8443:443"
```

```
$ docker-compose up -d
```

{{% /expand%}}

* GUI画面にアクセス
IPアドレス:8080をブラウザでアクセス

![](/images/rancher_access.PNG?height=400px)

admin
user

* パスワードを設定
* アクセスURLを設定 192.168.100.xxx:8443
* ClustersページからAdd Clusterをクリック
    * From existing nodes (Custom)をクリック
    * 任意の名前を入力
    * Advanced Optionを気を付けてNext (下記画像)
    * etcd, control, workerを選択しコマンドをコピーする
    * マスターノードで実行
    * workerのみを選択してコマンドをワーカーで実行
    * ノードに追加されればOK (少し時間がかかった)
    * ダッシュボードが表示されれば成功

![画像](/images/rancher_care.PNG?height=300px)
Nginx ingressになっていると80番ポートを使ってしまうため、後のHarborの設定が面倒になる

課題2：Rancherのコマンドのところもdocker-compose使ってやる
{{%expand "課題２回答" %}} 

```
$ mkdir rancher_node
$ cd rancher_node
$ vim docker-compose.yml
```

元のコマンド
※workerの場合は、--workerのみ
```
sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.4.8 --server https://192.168.100.201:8443 --token jjgxvwkhs4fz5b4dxgvfxkfpwjkn96l28n6wr9528tgn6v4pbn6xl4 --ca-checksum b0c9232bedaf1532ce0f9989667bb7d5da9493c29dc5acd98f46d924c7f0f070 --etcd --controlplane --worker
```

docker-composeコマンドのオプションで補完？


__docker-compose.yml__
```
version: '3'
services:
  rancher_cm:
    privileged: true
    restart: always
    net: "host"
    volumes:
      - /etc/kubernetes:/etc/kubernetes
      - /var/run:/var/run
    image: rancher/rancher-agent:v2.4.8
    
```

```
$ docker-compose up -d
```
{{% /expand%}}


* Kubeconfig Fileをクリック
![画像](/images/kubeconfig.PNG?height=500px)

* Worker側でこの内容を記載
```
$ mkdir .kube
$ vim .kube/config
# 張り付ける
```

* 成功すれば以下の内容が表示される！
![画像](/images/rancher_cluster.png?height=300px)
```
$ kubectl get nodes
```
![画像](/images/kubectl_cluster.png?height=100px)

#### GPUを利用するためのプラグインを導入
※[参考リンク](https://github.com/NVIDIA/k8s-device-plugin)

```
$ kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.7.3/nvidia-device-plugin.yml
```

* 試しにジョブを投入
```
$ kubectl run gpu-test --rm -t -i --restart=Never --image=nvidia/cuda:10.2-base --limits=nvidia.com/gpu=1 nvidia-smi
```

### nvidia-smiが実行できれば完璧！

##



