---
title: "ハンズオン3"
date: 2020-12-22T12:11:23+09:00
draft: true
weight: 103
---



## Harborのセットアップ
***
| Software | Version | Version Info | 
| -------- | ---------------------- |------|
| Harbor | 1.10.5 |https://github.com/goharbor/harbor/releases|

#### インストール手順
※[こちら](https://goharbor.io/docs/1.10/install-config/)を参考

* TLS無しのセットアップ
```
$ wget https://github.com/goharbor/harbor/releases/download/v1.10.5/harbor-offline-installer-v1.10.5.tgz
```
```
$ tar xzvf ./harbor-offline-installer-v1.10.5.tgz
```
```
$ cd harbor
```
```
$ vim harbor.yml
```
以下のように編集 IPアドレスはMasterノード
```
Hostname:192.168.100.xxx
http:
Port:80 # ここがalready useとなる場合、5000等にする

harbor_admin_passwd: password
# 下の部分はTLS絡みのため、コメントアウトする
# https:
# Ports:443
# certificate:
# private_key:
```
```
$ sudo ./install.sh
```
社内でプライベートレジストリのイメージを使用する場合は、暗号化通信に関する設定を事前にやる必要がある 
(管理/計算ノードどちらも)

※[参考](https://www.itmedia.co.jp/enterprise/articles/1708/25/news014_2.html)

```
$ sudo vim /etc/docker/daemon.json
```
下記をjsonに追加
```
{ "insecure-registries":[”192.168.100.xxx:80"] }
##プライベートレジストリ(管理ノード)のIPアドレス
```
```
$ sudo systemctl restart docker
```
ハーバーにログインできたらOK!!
http://192.168.100.xxx:80/

(手順通りならIDはadmin, pwはpassword)

![](/images/harborlogin.PNG?height=400px)


### NGCのアカウント作成とログイン
NGCのアカウントを作成してログイン
[こちら](https://ngc.nvidia.com/signin)

![](/images/ngc.PNG?height=500px)
アカウントのところをクリックしSetupを選択
Generate API Keyをクリック

![](/images/ngc_apikey.PNG?height=500px)
APIキーをメモし,DockerからNGCにログインする

### プライベートレポジトリとNGCにログイン
```
$ sudo docker login 192.168.100.xxx:80
```
NGCの手順やAPIキーを参考にNGCにもログイン
```
$ sudo docker login nvcr.io

```
```
Username：$oauthtoken 
Password：(NGCのkey)
```

NGCのイメージをpullしてプロキシ設定を付けるDockerfileを作成（任意のディレクトリで）
```
$ cd ../
$ mkdir test
$ cd test
```
```
$ vim Dokerfile
```
下記を記載する
```
FROM nvcr.io/nvidia/pytorch:20.09-py3
ENV http_proxy=http://proxy.pn.macnica.co.jp:10080
ENV https_proxy=http://proxy.pn.macnica.co.jp:10080
```
Dockerfileを使ってpull+build

pytorchのコンテナのため時間がかかります
```
$ sudo docker build -t 192.168.100.xxx/library/pytorch:20.09-py3 .
```
プライベートレポジトリにプッシュ
```
$ sudo docker push 192.168.100.xxx/library/pytorch:20.09-py3
```

保存されていることをHarborのGUIで確認してみてください
![](/images/harbor_confirm.PNG?height=500px)




