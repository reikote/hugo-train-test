---
title: "ハンズオン2"
date: 2020-12-22T12:11:23+09:00
draft: true
weight: 102
---

## kubernetes/helm/nvidia-docker/Rancherのインストール

### 管理ノード
| Software | Version | Version Info | 
| -------- | --------- |------------|
| kubectl    | 1.20 |https://kubernetes.io/ja/docs/tasks/tools/install-kubectl/#|
| helm    | 3.x |https://github.com/helm/helm/releases|

##### コンテナで実行
| Software | Version | Version Info | 
| -------- | ---------------------- |------|
| Rancher | 2.4.8 |https://rancher.com/support-maintenance-terms/all-supported-versions/rancher-v2.4.8/|

### 計算ノード
| Software | Version | Version Info | 
| -------- | ---------------------- |------|
| nvidia-docker2 | 2.x |https://github.com/NVIDIA/nvidia-docker|

### kubernetes
***
#### インストール手順
※[こちら](https://kubernetes.io/ja/docs/tasks/tools/install-kubectl/)を参考

```
$ curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
```
```
$ chmod +x ./kubectl
```
```
$ sudo mv ./kubectl /usr/local/bin/kubectl
```
バージョン確認できればOK!
```
$ kubectl version --client
```

### Helm
***
#### インストール手順
※[こちら](https://helm.sh/docs/intro/install/)を参考

```
$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
```
```
$ chmod 700 get_helm.sh
```
```
$ ./get_helm.sh
```

## nvidia-docker2
***
#### インストール手順
※[こちら](https://docs.nvidia.com/datacenter/cloud-native/kubernetes/dcgme2e.html#install-nvidia-container-toolkit-previously-nvidia-docker2)を参考

※計算ノードにインストール

```
$ distribution=$(. /etc/os-release;echo $ID$VERSION_ID) \
   && curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add - \
   && curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
```
```
$ sudo apt-get update \
   && sudo apt-get install -y nvidia-docker2
```

```
$ sudo vim /etc/docker/daemon.json
```
下記のように記述

[よく使うVimのコマンドまとめ](https://qiita.com/hide/items/5bfe5b322872c61a6896)

```
 {
   "default-runtime": "nvidia",
   "runtimes": {
        "nvidia": {
            "path": "/usr/bin/nvidia-container-runtime",
            "runtimeArgs": []
      }
   }
}
```
```
$ sudo systemctl restart docker
```

## Rancher
***
### Rancherの立ち上げ
※[参考リンク](https://rancher.com/docs/rancher/v2.x/en/quick-start-guide/deployment/quickstart-manual-setup/)

コンテナの起動
* ポートは被ると面倒なのでずらす
* Versionは2.4.8でないと上手くいかなかったので注意
```
$ sudo docker run -d --restart=unless-stopped -p 8080:80 -p 8443:443 rancher/rancher:v2.4.8
```

ブラウザで"管理ノードIPアドレス:8080”にアクセス
![](/images/rancher_access.PNG?height=400px)

* パスワードを設定
* アクセスURLを設定 192.168.100.xxx:8443
* ClustersページからAdd Clusterをクリック
    * From existing nodes (Custom)をクリック
    * Cluster Nameに任意の名前を入力
    * Advanced OptionタブでNginx ingressをDisabledに(下記画像)
    * Nextを選択
    * etcd, control, workerを選択しコマンドをコピーする
    * 管理ノードで実行
    * 次にworkerだけを選択して出てきたコマンドを計算ノードで実行
    * Nodesタブでノードが追加されていればOK
    * 数分してダッシュボードが表示されれば成功

![画像](/images/rancher_care.PNG?height=300px)

ダッシュボードの表示を確認後、Kubeconfig Fileをクリック
![画像](/images/kubeconfig.PNG?height=500px)

管理ノードにconfigの内容を記載
```
$ mkdir .kube
```
```
$ vim .kube/config
```

クラスタの作成に成功すれば以下の内容が表示される
![画像](/images/rancher_cluster.png?height=300px)
念のためコマンドでも確認！
```
$ kubectl get nodes
```
![画像](/images/kubectl_cluster.png?height=100px)

#### kubernetesでGPUを利用するためのプラグインを導入
※[参考リンク](https://github.com/NVIDIA/k8s-device-plugin)

```
$ kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.7.3/nvidia-device-plugin.yml
```

管理ノードから計算ノードにジョブを投入してみる
```
$ kubectl run gpu-test --rm -t -i --restart=Never --image=nvidia/cuda:10.2-base --limits=nvidia.com/gpu=1 nvidia-smi

$ kubectl run gpu-test --rm -t -i --restart=Never --image=nvidia/cuda:11.0-base --limits=nvidia.com/gpu=1 nvidia-smi
```

nvidia-smiが確認できればクラスタ構築成功

### おまけ：Rancherのカタログ機能を使ってみる



