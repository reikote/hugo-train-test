---
title: "コンテナイメージの作り方"
date: 2020-12-22T12:11:23+09:00
draft: true
weight: 8
---

## コンテナイメージの作り方とDockerfileのまとめ

※参考
[Dockerfileのベストプラクティス](http://docs.docker.jp/engine/articles/dockerfile_best-practice.html)

Docker, Docker-composeがインストールされていることが前提です。

### 試しにやってみる

```
$ mkdir python_test
$ cd python_test
$ echo "print(\"Hello World\")" > hello.py
$ vim Dockerfile
```

### Dockerfile
```
FROM python:3
ENV http_proxy=http://proxy.pn.macnica.co.jp:10080
ENV https_proxy=http://proxy.pn.macnica.co.jp:10080

ADD hello.py /example/
RUN apt-get update
RUN apt-get -y install locales && \
    localedef -f UTF-8 -i ja_JP ja_JP.UTF-8
ENV LANG ja_JP.UTF-8
ENV LANGUAGE ja_JP:ja
ENV LC_ALL ja_JP.UTF-8
ENV TZ JST-9
ENV TERM xterm

RUN apt-get install -y vim less
RUN pip install --upgrade pip
RUN pip install --upgrade setuptools
```

### 補足：Dockerfile命令解説
---
#### FROM [image:tag]
__コンテナイメージの取得先を選択するもの__

* 悪さをするイメージも存在するため、基本は公式(Dockerhub)のイメージを推奨
* とは言ってもNVIDIA関連はNGCから取ってくることが多い
    * (例) FROM nvcr.io/nvidia/pytorch:20.09-py3
* Dockerfileは必ずFROM命令からスタート

#### ENV [key] [value]
__環境変数を登録をするもの__
* proxyを設定する場合は、 http_proxyの後にURLを記載する

#### RUN [command]
__イメージの最上位レイヤーでコマンドを実行__
* コマンドはシェル内で実行される
* Linuxなら /bin/sh -c
* Windowsな cmd /S /C 

#### ADD [ファイルの場所,コピー先]
__イメージに任意のファイルを追加__

※色々あるため、詳細は下記のリンク

[Dockerfileコマンド参考リンク](http://docs.docker.jp/engine/reference/builder.html#from)

イメージの作成
```
$ docker build -t test/python:3.9 .
```
__docker build [-t イメージ名}[:タグ名]] Dockerfileのディレクトリ__

「-t」はイメージ名とタグ名を指定するオプション

イメージが出来たか確認する
```
$ docker images
```
![](/images/dockerfile_study1.PNG?height=40px)


#### Docker-composeで起動してみる

```
$ vim docker-compose.yml
```

#### docker-compose.yml
```
python3:
  restart: always
  image: test/python:3.9
  working_dir: '/root/'
  tty: true
  volumes:
    - ./opt:/root/opt
```
動作確認
```
$ docker-compose up -d
```

※補足：以下ならdocker buildせずとも直接dockerfileからビルド・実行までしてくれる(imageとbuildが差分)

```
version: '3'
services:
  python3:
    restart: always
    build: .
    container_name: 'python3'
    working_dir: '/root/'
    tty: true
    volumes:
      - ./opt:/root/opt
```

